---
title: "Cox PH Models"
author: "Landi Luo"
date: "12/7/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages:
```{r, message=FALSE}
if (!require("pacman"))  
  install.packages("pacman", repos = "http://cran.us.r-project.org/")
p_load("tidyverse", "survival", "kableExtra")
```

Import data:
```{r}
breast <- readRDS(file = "breast_final.rds")

# delete all survival time = 0
breast <- subset(breast, SRV_TIME_MON != 0)
```

## Cox Model: All Covariates

Using the Breslow method of handling ties, we fit a Cox proportional hazards model to the data including all 13 covariates: race, sex, stage, breast subtype, age dx, age, marital status, benign tumor count, malignant tumor count, primary site, pr status, er status, insurance status.

```{r}
fit <- coxph(Surv(SRV_TIME_MON, delta) ~ factor(SEX) + factor(stage) + factor(RAC_RECY) + 
             factor(BRST_SUB) + AGE_DX + Age + factor(MAR_STAT) + MALIGCOUNT + 
             BENBORDCOUNT + factor(PRIMSITE) + factor(ERSTATUS) + factor(PRSTATUS) + 
             factor(INSREC_PUB), data = breast, ties = "breslow")
summary(fit)
```

## ANOVA Table: All Covariates

We constructed an Analysis of Variance table to summarize estimates of the risk coefficients and the results of the one degree of freedom tests for each covariate in the model:
```{r}
anova_table <- data.frame(summary(fit)$coefficients)
kable(anova_table, "latex", booktabs = T,
      col.names = c("Coefficient", "Exp. Coeff.", "Std. Error", "Z-Score", "P-Value")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

## Cox Model: Top 9 Significant Variables
Using variable selection methods (LASSO, SCAD, MCP), we decided the top 9 significant variables were: 

- Stage
- ERSTATUS
- PRSTATUS
- MALIGCOUNT
- RAC_RECY
- PRIMSITE
- BRST_SUB
- MAR_STAT
- INSREC_PUB

We fit a Cox model with these covariates plus sex:
```{r}
fit2 <- coxph(Surv(SRV_TIME_MON, delta) ~ factor(SEX) + factor(stage) + factor(RAC_RECY) + 
             factor(BRST_SUB) + factor(MAR_STAT) + MALIGCOUNT + factor(PRIMSITE) + 
             factor(ERSTATUS) + factor(PRSTATUS) + factor(INSREC_PUB) , 
             data = breast, ties = "breslow" )
summary(fit2)
```

## Test PH Assumption for Sex

To test the proportional hazards assumption for Sex (a fixed-time covariate), we can create a time-dependent covariate $Z_2(t)$, defined as $Z_2(t)=Z_1 \times g(t)$, where g(t) is a known function of the time t. In most applications, we take $g(t)=\ln(t)$. A test of $H_0:\beta_2=0$ is a test of the proportional hazards assumption.
```{r}
# convert dataset into a counting process-like dataset
cut.points <- unique(breast$SRV_TIME_MON[breast$delta == 1])
breast2 <- survSplit(data = breast, cut = cut.points, end = "SRV_TIME_MON", start = "t0",
                     event = "delta")
head(breast2)

# create time-dependent covariate
breast2$tdc_sex <- breast2$SEX * log(breast2$SRV_TIME_MON)

coxph(Surv(t0, SRV_TIME_MON, delta) ~ SEX + tdc_sex, data = breast2, ties = "breslow")
```

Using $g(t)=\ln(t)$, the Wald p-value for the test of $H_0:\beta_2=0$ is 0.0091, which is significant at $\alpha=0.05$. Thus, there is evidence that `SEX` covariate has nonproportional hazards.


